# 总言



### 1、赛前准备和调研

​		在参加操作系统竞赛前，只上过操作系统的原理课程，实操有限。

​		所以在报名后近一个月的时间内，组内成员都在各自补充相关的知识，对linux，rtos等做了调研，发现不符合要求，便转向学习上一届的优秀项目。第一个进入我们视线的是xv6-k210项目。我们研究了他们的项目构成，发现代码比较复杂，结构难以掌握，于是转向学习xv6-riscv（见下文参考资料）。在学习xv6-riscv过程中发现xv6的x86架构版本与其有很大的不同，一些设计思路和riscv架构很难兼容，遂放弃x86版本。

​		首先，是对一个简化基于riscv架构的操作系统RVOS(见参考资料)进行了学习，了解了riscv指令集架构及其汇编的基本概念，riscv中断机制的软硬件实现和进程切换的简单思路。

​		接着，学习了MIT 6.S081的课程，并以xv6-riscv为例，从源码级逐行注释，了解较为成熟的操作系统的整体框架。也正是在这一过程中，逐渐深入操作系统内核，补充阅读了《深入理解计算机系统》部分章节、《程序员的自我修养——链接、装载与库》和《Linux GNU C 程序观察》前五章 等资料，了解操作系统是如何实现进程这一抽象的。

​		最后，研究了xv6-k210 使用rustSBI等工具在k210板子上运行操作系统内核的方法。最后，就开始手写自己的操作系统代码了。

​		在testOS大体框架，框架确定后，还学习了rCore(使用rust实现的OS内核)和chcore(微内核架构)的大体思路，前者因为语言不通，后者则是 架构差异较大，没有把握修改成功，都暂时搁置将两者的一些思路放入开发计划的想法。



### 2、系统框架

​		当前参赛的testOS内核是由本小组三人在借鉴MIT-xv6以及上届参赛队优秀作品的基础上，独立开发的一款具备分时进程调度、页式内存管理、elf可执行程序解析、fat32文件系统等功能的操作系统，并且支持初赛要求的所有系统调用。

​		对于内核的每个模块，我们小组都给出了专门的说明文档，并置于总言文档的同级目录中。以下给出testOS内核的各主要模块及其功能的简述，详细内容请参考各模块具体的说明文档：

#### 文件系统模块
    + SD卡驱动移植
    + 缓冲区管理
    + fat32文件系统
    + 初步实现VFS部分功能
    + 文件相关系统调用
    + 管道功能实现
    + 设备文件

#### 内存管理模块
    + 物理内存管理
    + 页式虚拟内存管理
    + 内存资源的分配与释放
    + 内存相关系统调用的实现

#### 进程管理模块
    + 进程的创建
    + 进程的调度与切换
    + 进程的阻塞
    + 进程的结束
    + 进程资源管理
    + elf可执行程序的加载
    + 进程相关系统调用

#### 设备管理模块
    + 控制台缓冲区
    + 控制台接收键盘输入字符串
    + 进程读取控制台缓冲区数据
    + 进程将数据写入控制台

#### trap处理模块
    + 时钟中断
    + 设备中断
    + 系统调用
    + 异常处理



### 3、开发计划与开发重要进展

开发过程中的重要进展包括（按时间先后顺序排列）：

（1）、3.15，成功在qemu模拟器上实现内核的启动初始化

（2）、3.16，在qemu模拟器上实现时钟中断

（3）、3.18，实现riscv架构下的页式内存管理

（4）、3.22，完成第一个系统调用（在屏幕上打印字符串）、成功运行第一个用户进程

（5）、3.26，实现进程循环轮转调度，完成`fork`系统调用

（6）、3.31，利用SBI，成功使现有的内核代码在K210开发板上运行起来

（7）、4.4，成功移植K210开发板的SD卡驱动，开始文件系统功能的开发

（8）、4.20，完成fat32文件系统读写文件功能的开发

（9）、4.25，完成execve系统调用，可以从SD卡上加载可执行文件

（10）、5.1，完成对fat32文件系统的长文件名目录项的解析

（11）、5.5，成功实现设备中断，可以接收键盘输入的字符串

（12）、5.15，完成所有进程管理相关的系统调用

（13）、5.22，完成fat32文件系统上的创建文件和删除文件功能

（14）、5.24，增加文件管理inode层，初步实现一些VFS的功能

（15）、5.27，完成pipe相关系统调用

（16）、5.27，完成所有内存管理相关系统调用

（17）、5.28，完成所有初赛要求的系统调用，并全部通过测试




### 4、遇到的主要问题及解决方案

（1）、在进行SD卡驱动移植时，我们发现K210开发板官方提供的SD卡驱动并不稳定，在连续地读写数十个扇区之后会出现问题。因此我们尝试移植上届参赛队xv6-k210的驱动，可是最终的测试结果与官方的驱动比起来并为进步多少（猜测是我们的移植问题，因为当时并未实现设备中断），因此目前暂时仍使用开发板官方提供的SD卡驱动，这个驱动在读写字节数量不多（大概不超过32K）的情况下一般可以稳定运行。

（2）、在实现设备中断功能时，我们发现K210开发板本身并没有提供S态的外部中断处理方法。而由于M态的所有工作全部交给了rustsbi处理，并且我们对rustsbi并不熟悉，因此陷入了困境。最后我们还是参考了xv6-k210的解决办法，我们了解到rustsbi为了解决这个问题在其内部增加了一个处理接口。于是我们学着xv6-k210的方式，编写了S态的中断处理代码，最终成功接收到了键盘输入的字符。

（3）、在开发fat32文件系统的创建文件功能时，我们发现我们自己内核创建的文件与主流操作系统如windows和ubuntu等并不能完全兼容。尽管我们尝试了很多方法，但是目前为止创建的文件在ubuntu中仍然只能显示为只读。除此之外，fat32文件系统的文件打开、读写、删除功能均已没有问题。

（4）、我们在如何进行远程评测的问题上花费了好几天的时间。最开始的时候我们并不清楚初赛的评测机制，也没有在官网上找到更加详细的说明。我们通过自己不断的尝试以及在竞赛官方群里咨询的方法才最终知道了远程评测时正确加载测试用例的方法，并成功通过了所有测试用例。




### 5、作品特征描述
​		本小组的作品是一个riscv架构的操作系统内核，它能够在k210开发板上正常工作，实现了内存管理、进程管理、文件管理、设备管理等功能。其中，内存管理采用的是页式虚存管理，进程管理采用的是循环轮转调度，文件系统实现的是FAT32文件系统并且实现了VFS的雏形，设备管理目前支持时钟和控制台而且其他的设备可以很容易地添加到现有的设备管理模块中。这些功能为应用程序的运行提供了所需的运行环境，使它们能够正确地并发运行并且合法访问系统资源以满足自身需要。



### 6、小组分工

雷涛铭：

​		参与比赛前期准备与调研、系统框架的搭建、trap的处理、进程管理功能的开发、SD卡驱动移植、文件管理模块的实现、内存管理功能的实现、内核各模块的调试与测试工作、文档的编写等。



王乙先：

​		参与比赛前期准备与调研、fat32文件系统功能的实现、设备管理模块的开发、内存相关系统调用的实现、文件系统与内存管理模块的调试与测试工作、文档的编写等。



马川湖：

​		参与比赛前期准备与调研、文件系统模块功能的开发、内核各模块的调试与测试工作、调研竞赛远程评测机的评判机制、文档的编写等。



### 7、提交仓库目录和文件描述
##### doc
存放的是竞赛文档和图片
##### kernel
存放的是内核源代码和sbi以及SD卡驱动的代码
+ ##### include
    存放的是内核源代码的头文件
+ ##### mcode
    存放的是内核在qemu上启动所必需的M态相关的代码
+ ##### rustsbi
    存放的是rustsbi的可执行程序，用来提供内核在K210运行的M态环境
+ ##### sd
    存放的是SD卡驱动的源代码和头文件
+ ##### buffer.c
    文件系统buffer层的代码
+ ##### console.c
    控制台输入输出的代码
+ ##### device.c
    设备管理的代码
+ ##### entry.S
    内核入口代码
+ ##### fat32.c
    文件系统fat32层的代码
+ ##### file.c
    文件系统file层的代码
+ ##### kerneltrapvec.S
    内核态中断的跳板代码
+ ##### load_store.S
    保存上下文中所有通用寄存器的代码
+ ##### pipe.c
    管道的代码
+ ##### plic.c
    PLIC的代码
+ ##### pm.c
    物理内存管理的代码
+ ##### printk.c
    内核打印功能的代码
+ ##### process.c
    进程管理的代码
+ ##### schedule.c
    进程调度的代码
+ ##### sleeplock.c
    睡眠锁的代码
+ ##### spinlock.c
    自旋锁的代码
+ ##### sstart.c
    内核初始化的代码
+ ##### string.c
    内核中字符串处理相关的代码
+ ##### syscall.c
    系统调用的代码
+ ##### sysexec.c
    将elf文件加载为进程的代码
+ ##### sysmmap.c
    内存映射文件的代码
+ ##### systime.c
    时钟相关的代码
+ ##### trap.c
    中断相关的代码
+ ##### usertrapvec.S
    用户态中断的跳板代码
+ ##### vfs_inode.c
    文件系统inode层的代码
+ ##### vm.c
    虚拟内存管理的代码
##### target
编译后生成的目标文件
##### tools
链接脚本和kflash
##### user
一些应用程序代码



### 8、比赛收获

​		通过这次比赛的初赛流程，我们小组三人对操作系统内核的理解有了质的提升。我们感到之前操作系统课程中的那些理论知识现在都与实际的开发融会贯通起来。对于操作系统的启动初始化、内存管理、进程管理、设备管理、文件管理、内陷处理等各模块，我们通过实际的动手操作都有了更深入的学习与了解。同时，我们学习到了riscv架构的相关知识，并深切地体会到了这一架构各方面的优势。在初赛的整个开发流程中，我们小组遇到过很多的困难，而我们通过不断的交流与尝试将这些困难一一克服，在收获知识的同时也增强了我们自己的团队协作能力和表达能力，并且获得了成就感。总之，无论结果如何，这次比赛的经历让我们小组的三人都受益匪浅。


### 9、参考资料

[xv6学习导引](https://blog.csdn.net/ConstineWhy/article/details/123313378)

#### 代码

[xv6-k210](https://github.com/HUST-OS/xv6-k210)

[xv6-riscv](https://github.com/mit-pdos/xv6-riscv)

#### 课程视频

[RVOS 教学课程目录](https://www.bilibili.com/video/BV1Q5411w7z5)

[6.S081 / Fall 2020](https://www.bilibili.com/video/BV19k4y1C7kA) 

[6.S081 课程翻译](https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081/lec01-introduction-and-examples)

[操作系统原型——xv6实验](https://space.bilibili.com/1040264970/video)

[xv6 内核调试](https://2017zhangyuxuan.github.io/2022/03/19/2022-03/2022-03-19%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E7%B3%BB%E5%88%97-xv6%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E6%95%99%E7%A8%8B/)

GDB调试

![image-20220326212151178](pic/%E5%89%8D%E6%9C%9F%E8%B0%83%E7%A0%94/image-20220326212151178.png)



#### 技术博客

[xv6源码阅读报告](https://blog.csdn.net/weixin_43912531/category_11554860.html)

[xv6实验报告](https://blog.csdn.net/lhwhit?type=blog)



#### 文档资料

riscv两本手册

![image-20220601193754071](pic/%E5%89%8D%E6%9C%9F%E8%B0%83%E7%A0%94/image-20220601193754071.png)

riscv 中文文档

![image-20220601193812825](pic/%E5%89%8D%E6%9C%9F%E8%B0%83%E7%A0%94/image-20220601193812825.png)

[xv6 中文文档](https://th0ar.gitbooks.io/xv6-chinese/content/index.html)


[riscv 指令集模块-麦克老狼](https://www.cnblogs.com/mikewolf2002/category/1329315.html?page=2)


《Linux GNU C 程序观察》——罗秋明

[xv6 all-in-one  实验](http://xv6.dgs.zone/)





#### 额外内容

rCore

https://rcore-os.github.io/rCore-Tutorial-Book-v3/chapter0/3os-hw-abstract.html

![image-20220326211439556](pic/%E5%89%8D%E6%9C%9F%E8%B0%83%E7%A0%94/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-16497708367512.md)



chcore

![image-20220601193929554](pic/%E5%89%8D%E6%9C%9F%E8%B0%83%E7%A0%94/image-20220601193929554.png)